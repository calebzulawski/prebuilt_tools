# This file is generated by generate/generate.py; do not edit.

load("@rules_conda//conda/environment:defs.bzl", "lock_environments")
load("@rules_multirun//:defs.bzl", "multirun")

_PACKAGE_SPECS = {
{{PACKAGE_SPECS}}
}

def define_conda_locks(*, macos_version, glibc_version):
    update_targets = []
    lock_paths = []
    for package, specs in _PACKAGE_SPECS.items():
        target = package + "_lock"
        lock_paths.append("private/locks/" + package + ".lock")
        lock_environments(
            name = target,
            environments = specs,
            lockfile = "locks/" + package + ".lock",
            macos_version = macos_version,
            glibc_version = glibc_version,
        )
        update_targets.append(":" + target + ".update")
    multirun(
        name = "lock_all",
        commands = update_targets,
    )
    ensure_lockfiles(
        name = "init_lock_files",
        lockfiles = lock_paths,
    )

def _ensure_lockfiles_impl(ctx):
    script = ctx.actions.declare_file(ctx.label.name + "_runner.sh")
    script_lines = [
        "#!/usr/bin/env bash",
        "set -euo pipefail",
        'WORKSPACE_DIR="${BUILD_WORKSPACE_DIRECTORY:-$PWD}"',
    ]
    for lockfile in ctx.attr.lockfiles:
        script_lines.append("touch \"${WORKSPACE_DIR}/%s\"" % (lockfile))
    ctx.actions.write(script, "\n".join(script_lines), is_executable = True)
    return [DefaultInfo(executable = script)]

ensure_lockfiles = rule(
    implementation = _ensure_lockfiles_impl,
    attrs = {"lockfiles": attr.string_list()},
    executable = True,
)
